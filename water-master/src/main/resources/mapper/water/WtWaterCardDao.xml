<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zscat.mallplus.water.mapper.WtWaterCardMapper">

    <!-- 更新卡列表的经销商信息 -->
    <update id="updateStoreId">
       UPDATE wt_water_card
       SET dealer_id=#{dealerId}
       ,update_time=NOW()
       ,update_by=#{updateBy}
       WHERE CAST(card_no AS SIGNED) BETWEEN #{sta} and #{end}
       AND del_flag =#{delFlag}
    </update>

    <!-- 获取分组下面是绑定的设备 -->
    <select id="getOneBy" resultType="com.zscat.mallplus.water.entity.WtWaterCard">
        SELECT * FROM wt_water_card
        WHERE del_flag =#{data.delFlag}
        <if test="data.cardNo != null ">
            AND card_no=#{data.cardNo}
        </if>
        LIMIT 1
    </select>

    <!-- 更新卡内余额 -->
    <update id="updateRecharge">
       UPDATE wt_water_card
       SET update_time=NOW()
          ,update_by=#{data.createBy}
        <if test="type != null and type == 'recharge' ">
            ,card_money=ifnull(card_money,0) + #{data.receivedMoney}
            ,give_money= #{data.rechargeMoney} - #{data.receivedMoney}
        </if>
        <if test="type != null and type == 'experience' ">
		  ,experience_money = #{data.experienceMoney}
		  ,experience_end_data = #{data.experienceEndData}
        </if>
       WHERE del_flag =#{delFlag}
		 AND state=#{state}
        <if test="data != null and data.startNo != null ">
            AND CAST(card_no AS SIGNED) BETWEEN #{data.startNo} and #{data.endNo}
        </if>
        <if test="data != null and data.cardNo != null ">
            AND CAST(card_no AS SIGNED) = #{data.cardNo}
        </if>

    </update>

    <!-- 根据开卡id获取售出卡信息 -->
    <select id="getAllSaleStateOn" resultType="com.zscat.mallplus.water.entity.WtWaterCard">
        SELECT a.* FROM wt_water_card a
        LEFT JOIN wt_water_card_activate b
        ON  CAST(a.card_no AS SIGNED) BETWEEN b.start_no and b.end_no
        WHERE b.id= #{id}
        <if test="saleStateOn != null ">
            AND a.sale_state=#{saleStateOn}
        </if>

    </select>

    <!-- 根据卡号和用户id获取水卡信息 -->
    <select id="getWaterCard" resultType="com.zscat.mallplus.water.entity.WtWaterCard">
        SELECT * FROM wt_water_card a
        WHERE a.del_flag =#{delFlag}
        AND a.state=#{state}
        AND a.ums_member_id=#{umsMemberId}
        AND a.card_no=#{cardNo}
        LIMIT 0,1
    </select>

</mapper>
