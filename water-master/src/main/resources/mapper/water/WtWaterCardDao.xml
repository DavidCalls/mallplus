<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zscat.mallplus.water.mapper.WtWaterCardMapper">

    <!-- 更新卡列表的经销商信息 -->
    <update id="updateStoreId">
       UPDATE wt_water_card
       SET dealer_id=#{dealerId}
       ,update_time=NOW()
       ,update_by=#{updateBy}
       WHERE CAST(card_no AS SIGNED) BETWEEN #{sta} and #{end}
       AND del_flag =#{delFlag}
    </update>

    <!-- 获取分组下面是绑定的设备 -->
    <select id="getOneBy" resultType="com.zscat.mallplus.water.entity.WtWaterCard">
        SELECT * FROM wt_water_card
        WHERE del_flag =#{data.delFlag}
        <if test="data.cardNo != null ">
            AND card_no=#{data.cardNo}
        </if>
        LIMIT 1
    </select>

    <!-- 更新卡内余额 -->
    <update id="updateRecharge">
       UPDATE wt_water_card
       SET update_time=NOW()
          ,update_by=#{data.createBy}
        <if test="type != null and type == 'recharge' ">
            ,card_money=ifnull(card_money,0) + #{data.receivedMoney}
            ,give_money= #{data.rechargeMoney} - #{data.receivedMoney}
        </if>
        <if test="type != null and type == 'experience' ">
		  ,experience_money = #{data.experienceMoney}
		  ,experience_end_data = #{data.experienceEndData}
        </if>
       WHERE del_flag =#{delFlag}
		 AND state=#{state}
        <if test="data != null and data.startNo != null ">
            AND CAST(card_no AS SIGNED) BETWEEN #{data.startNo} and #{data.endNo}
        </if>
        <if test="data != null and data.cardNo != null ">
            AND CAST(card_no AS SIGNED) = #{data.cardNo}
        </if>

    </update>

    <!-- 根据开卡id获取售出卡信息 -->
    <select id="getAllSaleStateOn" resultType="com.zscat.mallplus.water.entity.WtWaterCard">
        SELECT a.* FROM wt_water_card a
        LEFT JOIN wt_water_card_activate b
        ON  CAST(a.card_no AS SIGNED) BETWEEN b.start_no and b.end_no
        WHERE b.id= #{id}
        <if test="saleStateOn != null ">
            AND a.sale_state=#{saleStateOn}
        </if>

    </select>

    <!-- 根据卡号和用户id获取水卡信息 -->
    <select id="getWaterCard" resultType="com.zscat.mallplus.water.entity.WtWaterCard">
        SELECT * FROM wt_water_card a
        WHERE a.del_flag =#{delFlag}
        AND a.state=#{state}
        AND a.ums_member_id=#{umsMemberId}
        AND a.card_no=#{cardNo}
        LIMIT 0,1
    </select>
    <!-- 根据卡号修改卡状态 -->
    <update id="updateStateByCard">
        UPDATE wt_water_card
        SET update_time=NOW()
        ,update_by=#{updateBy}
        ,state = #{state}
        WHERE  card_no = #{cardNo}

    </update>

    <!-- 根据条件查询所有会员表列表 -->
    <select id="selectData" resultType="com.zscat.mallplus.water.entity.WtWaterCard">
        SELECT
        b.username AS "username",
        b.phone AS "phone",
        c.NAME AS "uniacName",
        GROUP_CONCAT( e.label_name ) AS "labelName",
        f.eqcode,
        h.eq_address AS "eqAddress",
        i.username AS "saleByName",
        j.username AS "umsMemberReferrerName",
        a.*
        FROM
        wt_water_card a
        LEFT JOIN ums_member b ON a.ums_member_id=b.id
        LEFT JOIN account_wechats c ON c.uniacid = b.uniacid
        LEFT JOIN sms_label_member d ON d.member_id = b.id
        LEFT JOIN sms_label_set e ON d.label_id = e.id
        LEFT JOIN (SELECT eqcode,card_no
        from wt_equipment_warter_card
        GROUP BY card_no
        )f ON f.card_no=a.card_no
        LEFT JOIN wt_equipment h ON f.eqcode=h.eqcode
        LEFT JOIN sys_user_staff i ON a.sale_by = i.id
        LEFT JOIN ums_member j ON a.ums_member_referrer_id = j.id
        WHERE a.del_flag=#{entity.delFlag}
        <if test="entity.cardType != null and entity.cardType != ''">
            AND a.card_type=#{entity.cardType}
        </if>
        <if test="entity.cardNo != null and entity.cardNo != ''">
            AND a.card_no=#{entity.cardNo}
        </if>
        <if test="entity.username != null and entity.username != ''">
            AND b.username=#{entity.username}
        </if>
        <if test="entity.weixinOpenid != null and entity.weixinOpenid != ''">
            AND b.weixin_openid=#{entity.weixinOpenid}
        </if>
        <if test="entity.id != null and entity.id != ''">
            AND a.id=#{entity.id}
        </if>

        <if test="entity.umsMemberName != null and entity.umsMemberName != ''">
            AND c.name like concat('%',#{entity.umsMemberName},'%')
        </if>
        <if test="entity.saleState != null and entity.saleState != ''">
            AND a.sale_state=#{entity.saleState}
        </if>
        <if test="entity.activationState != null and entity.activationState != ''">
            AND a.activation_state=#{entity.activationState}
        </if>

        <if test="entity.umsMemberReferrerName != null and entity.umsMemberReferrerName != ''">
            AND j.username=#{entity.umsMemberReferrerName}
        </if>
        GROUP BY a.id
    </select>

    <!-- 根据条件查询所有会员表列表 -->
    <select id="selectProblemData" resultType="com.zscat.mallplus.water.entity.WtWaterCard">
        SELECT
        b.username AS "username",
        a.*
        FROM
        wt_water_card a
        LEFT JOIN ums_member b ON a.ums_member_id=b.id
        WHERE a.del_flag=#{entity.delFlag}
        AND a.state != #{state}
        <if test="entity.cardType != null and entity.cardType != ''">
            AND a.card_type=#{entity.cardType}
        </if>
        <if test="entity.cardNo != null and entity.cardNo != ''">
            AND a.card_no=#{entity.cardNo}
        </if>
        GROUP BY a.id
    </select>
</mapper>
